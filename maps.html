<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aura Maps</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase 8.10.0 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<style>
:root { --accent:#E515F6; --bg:#fff; --text:#111; --border:#ddd; --radius:12px; }
html,body{margin:0;height:100%;font-family:Arial,sans-serif;}
body{overflow:hidden;background:var(--bg);}
.topbar{display:flex;justify-content:space-between;align-items:center;height:50px;padding:0 10px;background:#fff;border-bottom:1px solid var(--border);}
.topbar img.profile{width:36px;height:36px;border-radius:50%;cursor:pointer;}
.toggleSidebar{font-size:24px;color:var(--accent);cursor:pointer;}
.sidebar{position:absolute;top:50px;bottom:0;left:0;width:280px;background:#fff;border-right:1px solid var(--border);transform:translateX(-100%);transition:0.3s;display:flex;flex-direction:column;padding:10px;overflow-y:auto;z-index:1000;}
.sidebar.active{transform:translateX(0);}
.sidebar h3{margin-top:0;color:var(--accent);}
.sidebar input,.sidebar button{margin-top:5px;padding:8px;border-radius:var(--radius);border:1px solid #ccc;}
.sidebar button.action{background:var(--accent);color:#fff;border:none;}
.map{height:calc(100% - 50px);}
#map{width:100%;height:100%;}
.place-item{padding:8px;border:1px solid #ddd;border-radius:var(--radius);margin-bottom:6px;cursor:pointer;background:#fafafa;}
.downbar{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:1px solid var(--border);padding:12px;display:none;z-index:1500;max-height:50%;overflow-y:auto;}
.downbar img{width:100%;border-radius:var(--radius);margin-top:8px;}
</style>
</head>
<body>

<div class="topbar">
  <span class="toggleSidebar" onclick="toggleSidebar()">‚ò∞</span>
  <img src="auraaccount.png" class="profile" id="profileImg" onclick="showProfilePopup()">
</div>

<div class="sidebar" id="sidebar">
  <h3>Cerca citt√†</h3>
  <input type="text" id="searchInput" placeholder="Es. Napoli">
  <button class="action" onclick="searchPlace()">Cerca</button>
  <h3>I tuoi preferiti</h3>
  <div id="placesList"></div>
  <h3>Azioni rapide</h3>
  <button class="action" id="gpsBtn" onclick="requestLocation()">üìç Usa GPS</button>
</div>

<div class="map">
  <div id="map"></div>
</div>

<div class="downbar" id="downbar">
  <h3 id="cityName"></h3>
  <p id="cityInfo"></p>
  <img id="cityImg" src="">
  <p id="cityStats"></p>
</div>

<div class="overlay" id="overlay"></div>
<div class="dialog" id="profilePopup">
  <p>Per gestire il tuo profilo, vai su <b>os.aurastudioitalia.it</b> o scarica <b>Aura+</b> su Google Play Store.</p>
  <button onclick="closeProfilePopup()">Chiudi</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
  authDomain: "myauraid-f03c6.firebaseapp.com",
  projectId: "myauraid-f03c6",
  storageBucket: "myauraid-f03c6.appspot.com",
  messagingSenderId: "190478237725",
  appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let user = null;
let map = L.map('map',{zoomControl:false}).setView([40.85,14.27],6);

// Tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

// Sidebar toggle
function toggleSidebar(){document.getElementById("sidebar").classList.toggle("active");}

// Profile popup
function showProfilePopup(){document.getElementById("profilePopup").style.display="block";document.getElementById("overlay").style.display="block";}
function closeProfilePopup(){document.getElementById("profilePopup").style.display="none";document.getElementById("overlay").style.display="none";}

// Login check
auth.onAuthStateChanged(u=>{
  if(!u) window.location.href="index.html";
  user = u;
  // Carica immagine da Storage
  storage.ref(`users/${user.uid}/profileImage`).getDownloadURL()
    .then(url=> document.getElementById("profileImg").src = url)
    .catch(()=> console.log("Nessuna immagine profilo"));
  loadFavoritePlaces();
});

// GPS
const gpsBtn = document.getElementById("gpsBtn");
function requestLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      gpsBtn.textContent="Mostra dove sei";
      const c=[pos.coords.latitude,pos.coords.longitude];
      map.setView(c,15);
      L.marker(c).addTo(map).bindPopup("Sei qui").openPopup();
    });
  }else alert("GPS non supportato");
}

// Salvataggio preferiti
function saveFavoritePlace(name,lat,lon){
  if(!user) return;
  db.collection("users").doc(user.uid).collection("Maps").add({
    luogo:{name,lat,lon},
    favorite:true,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>console.log("Luogo salvato:",name))
  .catch(err=>console.error("Errore:",err.message));
}

// Caricamento preferiti
function loadFavoritePlaces(){
  db.collection("users").doc(user.uid).collection("Maps")
    .where("favorite","==",true)
    .orderBy("timestamp","desc")
    .onSnapshot(snapshot=>{
      const list=document.getElementById("placesList");
      list.innerHTML="";
      snapshot.forEach(doc=>{
        const data=doc.data().luogo;
        const div=document.createElement("div");
        div.className="place-item";
        div.textContent=data.name;
        div.onclick=()=> map.setView([data.lat,data.lon],14);
        list.appendChild(div);
      });
    });
}

// Ricerca citt√† + downbar info
function searchPlace(){
  const q = document.getElementById("searchInput").value;
  if(!q) return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
    .then(res=>res.json())
    .then(data=>{
      if(data.length>0){
        const city=data[0];
        const lat=city.lat, lon=city.lon;
        map.setView([lat,lon],12);
        L.marker([lat,lon]).addTo(map)
          .bindPopup(`<b>${city.display_name}</b><br><button onclick="saveFavoritePlace('${city.display_name}',${lat},${lon})">‚ù§Ô∏è Preferito</button>`).openPopup();
        showDownbar(city);
      }else alert("Nessun risultato trovato");
    });
}

// Downbar info
function showDownbar(city){
  document.getElementById("cityName").textContent = city.display_name;
  document.getElementById("cityInfo").textContent = `Lat: ${city.lat}, Lon: ${city.lon}`;
  document.getElementById("cityImg").src = `https://source.unsplash.com/400x200/?${city.display_name}`;
  
  // Statistiche (simulazione percorsi)
  document.getElementById("cityStats").innerHTML=
    `üö∂ A piedi: 20 min | üö¥ Bici: 10 min | üöó Auto: 5 min | üöå Bus: 8 min`;
  document.getElementById("downbar").style.display="block";
}
</script>
</body>
</html>
