<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aura Maps</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Firebase 8.10.0 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --mag: #E515F6;
  --bg: #ffffff;
  --muted: #777782;
  --radius: 14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:#111}

/* Topbar */
.topbar{position:fixed;top:0;left:0;right:0;height:64px;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:4000;border-bottom:1px solid rgba(0,0,0,0.04)}
.brand{display:flex;align-items:center;gap:12px;font-weight:700;color:var(--mag)}
.hamburger{font-size:22px;cursor:pointer}
.profile-img{width:46px;height:46px;border-radius:999px;object-fit:cover;cursor:pointer;border:2px solid rgba(0,0,0,0.06)}

/* Sidebar */
.sidebar{position:fixed;top:74px;left:16px;bottom:16px;width:340px;max-width:86%;background:#fff;border-radius:var(--radius);padding:16px;box-shadow:0 18px 50px rgba(2,6,23,0.08);overflow:auto;transform:translateX(-125%);transition:transform .22s ease;z-index:3500}
.sidebar.open{transform:translateX(0)}
.search-row{display:flex;gap:8px;margin-bottom:12px}
.search-row input{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
.btn{background:var(--mag);color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;font-weight:700}
.small-btn{background:#f6f6fb;border:1px solid #eee;padding:6px 8px;border-radius:10px;cursor:pointer}
.toggle-row{display:flex;align-items:center;gap:8px;margin:8px 0}
.toggle-row label{font-size:14px;color:var(--muted)}

/* Map */
#map{position:fixed;top:64px;left:0;right:0;bottom:0;z-index:0;border-top-left-radius:0}

/* Downbar */
.downbar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:92%;max-width:880px;background:#fff;border-radius:16px;padding:14px;box-shadow:0 18px 60px rgba(2,6,23,0.14);display:none;z-index:3600}
.downbar.open{display:block}
.downbar .close{position:absolute;right:12px;top:8px;background:none;border:0;font-size:18px;cursor:pointer;color:var(--mag)}
.place-photo{width:100%;height:180px;object-fit:cover;border-radius:10px;margin-top:8px}

/* favorites list items */
.fav-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:#fbfbff;border:1px solid #eee;margin-bottom:10px}
.fav-item .title{font-weight:700;color:var(--mag);cursor:pointer}
.fav-actions{display:flex;gap:8px}

/* route legend */
.route-legend{display:flex;gap:10px;margin-top:8px;font-size:13px}

/* Toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:110px;background:rgba(0,0,0,0.84);color:white;padding:8px 12px;border-radius:10px;display:none;z-index:4100}

/* Responsive */
@media(max-width:720px){
  .sidebar{width:92%;left:4%;top:66px}
  .downbar{left:6px;transform:none;width:calc(100% - 12px)}
}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand"><span id="hamburger" class="hamburger">☰</span><span>AuraMaps</span></div>
  <img id="profile-img" class="profile-img" src="https://aurastudioitalia.it/antogalaxyavatar.png" alt="Immagine del profilo">
</header>

<aside id="sidebar" class="sidebar" aria-hidden="true">
  <h3>Ricerca & Preferiti</h3>
  <div class="search-row">
    <input id="searchInput" type="search" placeholder="Cerca città, indirizzo o luogo..." />
    <button id="searchBtn" class="btn">Cerca</button>
  </div>

  <div style="margin-bottom:10px;">
    <button id="gpsBtn" class="btn" style="width:100%;">Mostra dove sei</button>
  </div>

  <div class="toggle-row">
    <label for="poiToggle">Mostra POI</label>
    <input id="poiToggle" type="checkbox">
    <span id="poiToggleLabel" style="margin-left:auto;color:var(--muted)">No</span>
  </div>

  <h4>Preferiti</h4>
  <div id="favoritesList" style="margin-bottom:12px"></div>

  <hr style="border:none;height:1px;background:#f1f1f5;margin:12px 0;">
  <div style="font-size:13px;color:var(--muted)">Se non hai un account, crealo su <a href="https://os.aurastudioitalia.it" target="_blank">os.aurastudioitalia.it</a> o scarica Aura+ su Google Play Store.</div>
</aside>

<div id="map"></div>

<div id="downbar" class="downbar" role="dialog" aria-hidden="true">
  <button class="close" id="downbarClose">✖</button>
  <div id="downbarInner"></div>
  <div style="display:flex;gap:10px;margin-top:12px;">
    <button id="addFavBtn" class="btn">Aggiungi ai preferiti</button>
    <button id="navBtn" class="small-btn">Calcola percorso</button>
    <button id="clearRoutesBtn" class="small-btn">Rimuovi tracce</button>
  </div>
  <div class="route-legend" id="routeLegend"></div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===================== CONFIG ===================== */
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImUwYzIxYjc2ZmQyNTRiYzY4YTUxNTVlNmIyOGViNDJmIiwiaCI6Im11cm11cjY0In0=";

/* Firebase config (fornito da te) */
const firebaseConfig = {
  apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
  authDomain: "myauraid-f03c6.firebaseapp.com",
  projectId: "myauraid-f03c6",
  storageBucket: "myauraid-f03c6.appspot.com",
  messagingSenderId: "190478237725",
  appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
/* ================================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* UI refs */
const profileImg = document.getElementById('profile-img');
const hamburgerBtn = document.getElementById('hamburger');
const sidebarEl = document.getElementById('sidebar');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const gpsBtn = document.getElementById('gpsBtn');
const poiToggle = document.getElementById('poiToggle');
const poiToggleLabel = document.getElementById('poiToggleLabel');
const favoritesListEl = document.getElementById('favoritesList');
const downbar = document.getElementById('downbar');
const downbarInner = document.getElementById('downbarInner');
const downbarClose = document.getElementById('downbarClose');
const addFavBtn = document.getElementById('addFavBtn');
const navBtn = document.getElementById('navBtn');
const clearRoutesBtn = document.getElementById('clearRoutesBtn');
const routeLegend = document.getElementById('routeLegend');
const toastEl = document.getElementById('toast');

/* State */
let currentUser = null;
let map = null;
let poiMarkers = [];
let currentPlace = null; // shown in downbar, may contain _mapKey if saved
let userDocUnsub = null;
let favoritesListenUnsub = null;
let overpassController = null;
let showPOI = (localStorage.getItem('aura_show_poi') === '1');
let routeLayers = {};
const routeColors = { 'foot-walking':'#2ecc71', 'cycling-regular':'#3498db', 'driving-car':'#E515F6' };

/* ---------- Utilities ---------- */
function showToast(msg, ms=2200){ toastEl.textContent = msg; toastEl.style.display='block'; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toastEl.style.display='none', ms); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }
function nowKey(){ return Date.now().toString() + '-' + Math.random().toString(36).slice(2,8); }
function sanitizePlace(place){ return {
  name: String(place.name || '').slice(0,300),
  lat: Number(place.lat || place.latitude || 0),
  lng: Number(place.lng || place.longitude || place.lon || 0),
  address: String(place.address || '').slice(0,800),
  photo: String(place.photo || '').slice(0,1200),
  info: String(place.info || '').slice(0,2000),
  addedAt: firebase.firestore.FieldValue.serverTimestamp()
};}

/* ---------- Auth & Profile image (realtime) ---------- */
auth.onAuthStateChanged(async (user) => {
  if(!user){
    window.location.href = 'index.html';
    return;
  }
  currentUser = user;

  // listen to user doc to get profileImage and Maps field updates
  const userDocRef = db.collection('users').doc(currentUser.uid);
  if(userDocUnsub) userDocUnsub();
  userDocUnsub = userDocRef.onSnapshot(snapshot => {
    if(!snapshot.exists){
      // create minimal doc if missing
      userDocRef.set({ profileImage: "https://aurastudioitalia.it/antogalaxyavatar.png" }, { merge: true });
      profileImg.src = "https://aurastudioitalia.it/antogalaxyavatar.png";
      return;
    }
    const data = snapshot.data() || {};
    // profileImage is a string URL
    profileImg.src = (typeof data.profileImage === 'string' && data.profileImage.trim().length) ? data.profileImage : "https://aurastudioitalia.it/antogalaxyavatar.png";
    // reload favorites UI from Maps field if present
    renderFavoritesFromMapsField(data.Maps || {});
  }, err => {
    console.error('userDoc onSnapshot error', err);
  });

  // init map & UI now that we have user
  initMap();
  attachUIHandlers(); // handlers that depend on auth/map
});

/* profile click */
profileImg.addEventListener('click', ()=> {
  alert("Per gestire il tuo profilo, vai su os.aurastudioitalia.it o scarica Aura+ su Google Play Store.");
});

/* ---------- Sidebar UI ---------- */
hamburgerBtn.addEventListener('click', ()=> sidebarEl.classList.toggle('open'));

poiToggle.addEventListener('change', ()=>{
  showPOI = poiToggle.checked;
  localStorage.setItem('aura_show_poi', showPOI ? '1' : '0');
  poiToggleLabel.textContent = showPOI ? 'Sì' : 'No';
  if(!showPOI) clearPOIMarkers();
  else if(map && map.getZoom() >= 13) loadPOI();
});

/* ---------- Map init ---------- */
function initMap(){
  if(map) return;
  map = L.map('map', { zoomControl: true }).setView([45.4642, 9.19], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  map.on('moveend', debounce(()=> {
    if(!showPOI) return;
    if(map.getZoom() < 13){ clearPOIMarkers(); return; }
    const b = map.getBounds();
    const latSpan = Math.abs(b.getNorth() - b.getSouth());
    const lngSpan = Math.abs(b.getEast() - b.getWest());
    if(latSpan > 1.4 || lngSpan > 2.0){ clearPOIMarkers(); showToast('Avvicinati per caricare POI'); return; }
    loadPOI();
  }, 700));

  // click: reverse geocode and open downbar (NO prompt)
  map.on('click', async (e) => {
    try{
      const lat = e.latlng.lat, lon = e.latlng.lng;
      const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      if(!resp.ok) throw new Error('Reverse failed');
      const data = await resp.json();
      const name = data.display_name || `Posizione ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      const place = { name, lat, lng: lon, address: data.display_name || '', photo:'', info:'', _mapKey: null };
      showDownbar(place);
    }catch(err){
      console.error('map click reverse error', err);
      showToast('Errore recupero indirizzo');
    }
  });
}

/* ---------- POI (Overpass) ---------- */
function clearPOIMarkers(){
  poiMarkers.forEach(m => { try{ map.removeLayer(m); }catch(e){} });
  poiMarkers = [];
  if(overpassController){ try{ overpassController.abort(); }catch(e){} overpassController = null; }
}

async function loadPOI(){
  if(!showPOI) return;
  clearPOIMarkers();
  const b = map.getBounds();
  const s = b.getSouth(), w = b.getWest(), n = b.getNorth(), e = b.getEast();
  if(Math.abs(n - s) > 1.4 || Math.abs(e - w) > 2.0){ showToast('Area troppo ampia per POI'); return; }

  const query = `[out:json][timeout:20];
(
  node["amenity"~"restaurant|cafe|bar|fast_food|hotel|pub|bakery|supermarket|pharmacy"](${s},${w},${n},${e});
  way["amenity"~"restaurant|cafe|bar|fast_food|hotel|pub|bakery|supermarket|pharmacy"](${s},${w},${n},${e});
);
out center 150;`;

  overpassController = new AbortController();
  try{
    const res = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body: query, signal: overpassController.signal });
    if(!res.ok) throw new Error('Overpass error ' + res.status);
    const json = await res.json();
    const elements = json.elements || [];
    elements.slice(0,120).forEach(el => {
      const lat = el.lat || (el.center && el.center.lat);
      const lon = el.lon || (el.center && el.center.lon);
      if(!lat || !lon) return;
      const tags = el.tags || {};
      const name = tags.name || '(Senza nome)';
      const address = [tags['addr:street'], tags['addr:housenumber'], tags['addr:city']].filter(Boolean).join(' ');
      const marker = L.marker([lat, lon]).addTo(map);
      poiMarkers.push(marker);
      marker.on('click', ()=> {
        const place = { name, address, lat, lng: lon, photo:'', info:'Recensioni non disponibili', _mapKey: null };
        showDownbar(place);
      });
    });
  }catch(err){
    if(err.name === 'AbortError'){ console.log('Overpass aborted'); return; }
    console.warn('loadPOI err', err);
  }finally{
    overpassController = null;
  }
}

/* ---------- Favorites stored INSIDE users/{uid}.Maps (field) ---------- */
/*
 Structure:
 users/{uid}.Maps = {
   "<mapKey>": { name, lat, lng, address, photo, info, addedAt: Timestamp }
 }
*/

// Render favorites list when Maps field changes (called from user doc snapshot)
function renderFavoritesFromMapsField(mapsObj){
  favoritesListEl.innerHTML = '';
  const keys = Object.keys(mapsObj || {});
  if(keys.length === 0){
    favoritesListEl.innerHTML = '<div style="color:var(--muted);padding:8px">Nessun preferito</div>';
    return;
  }
  keys.sort((a,b) => { // newest first if timestamp present
    const ta = mapsObj[a] && mapsObj[a].addedAt && mapsObj[a].addedAt.toMillis ? mapsObj[a].addedAt.toMillis() : 0;
    const tb = mapsObj[b] && mapsObj[b].addedAt && mapsObj[b].addedAt.toMillis ? mapsObj[b].addedAt.toMillis() : 0;
    return tb - ta;
  });
  keys.forEach(key => {
    const place = mapsObj[key];
    const item = document.createElement('div');
    item.className = 'fav-item';
    item.innerHTML = `<div style="flex:1"><div class="title">${escapeHtml(place.name||'Luogo')}</div>
      <div style="font-size:12px;color:var(--muted)">${escapeHtml(place.address||'')}</div></div>
      <div class="fav-actions">
        <button class="small-btn" data-go="${key}" data-lat="${place.lat}" data-lng="${place.lng}">Vai</button>
        <button class="small-btn" data-del="${key}" style="background:#ffecec;border:1px solid #f0c0c0;color:#c00">Elimina</button>
      </div>`;
    favoritesListEl.appendChild(item);

    // go button
    item.querySelector('[data-go]')?.addEventListener('click', (ev)=>{
      const lat = parseFloat(ev.currentTarget.dataset.lat), lng = parseFloat(ev.currentTarget.dataset.lng);
      map.setView([lat,lng],15);
    });

    // delete button
    item.querySelector('[data-del]')?.addEventListener('click', async (ev)=>{
      const keyToDel = ev.currentTarget.dataset.del;
      if(!confirm('Eliminare questo preferito?')) return;
      try{
        // transaction to remove key
        const userRef = db.collection('users').doc(currentUser.uid);
        await db.runTransaction(async tx => {
          const doc = await tx.get(userRef);
          if(!doc.exists) return;
          const data = doc.data() || {};
          const Maps = data.Maps || {};
          if(Maps[keyToDel]) delete Maps[keyToDel];
          tx.update(userRef, { Maps });
        });
        showToast('Preferito eliminato');
      }catch(e){
        console.error('delete favorite transaction err', e);
        showToast('Errore eliminazione');
      }
    });

    // clicking title opens downbar for that place
    item.querySelector('.title')?.addEventListener('click', ()=>{
      const lat = parseFloat(item.querySelector('[data-go]').dataset.lat), lng = parseFloat(item.querySelector('[data-go]').dataset.lng);
      const place = Object.assign({}, mapsObj[item.querySelector('[data-go]').dataset.go] || mapsObj[item.querySelector('[data-go]').dataset.go]);
      // ensure lat/lng present
      place.lat = place.lat || lat;
      place.lng = place.lng || lng;
      place._mapKey = item.querySelector('[data-go]').dataset.go;
      map.setView([place.lat, place.lng], 15);
      showDownbar(place);
    });
  });
}

// Add a favorite: writes to users/{uid} document, field Maps, using transaction to avoid race
async function addFavoriteToMapsField(place){
  if(!place) return showToast('Nessun luogo selezionato');
  const sanitized = sanitizePlace(place);
  const key = nowKey();
  try{
    const userRef = db.collection('users').doc(currentUser.uid);
    await db.runTransaction(async tx => {
      const doc = await tx.get(userRef);
      if(!doc.exists){
        tx.set(userRef, { Maps: { [key]: sanitized } }, { merge: true });
        return;
      }
      const data = doc.data() || {};
      const Maps = data.Maps || {};
      Maps[key] = sanitized;
      tx.update(userRef, { Maps });
    });
    // attach the mapKey to currentPlace so UI updates correctly
    currentPlace._mapKey = key;
    showToast('Preferito aggiunto');
  }catch(e){
    console.error('addFavoriteToMapsField transaction err', e);
    if(e && e.code === 'permission-denied') showToast('Permesso negato: controlla le regole Firestore.');
    else showToast('Errore salvataggio: ' + (e.message || e));
  }
}

// Remove favorite by mapKey (field)
async function removeFavoriteFromMapsField(mapKey){
  if(!mapKey) return;
  try{
    const userRef = db.collection('users').doc(currentUser.uid);
    await db.runTransaction(async tx => {
      const doc = await tx.get(userRef);
      if(!doc.exists) return;
      const data = doc.data() || {};
      const Maps = data.Maps || {};
      if(Maps[mapKey]) delete Maps[mapKey];
      tx.update(userRef, { Maps });
    });
    showToast('Preferito rimosso');
    // if currentPlace referenced this key, clear it
    if(currentPlace && currentPlace._mapKey === mapKey) { currentPlace._mapKey = null; downbar.classList.remove('open'); }
  }catch(e){
    console.error('removeFavoriteFromMapsField err', e);
    showToast('Errore rimozione');
  }
}

/* ---------- DOWNBAR ---------- */
async function showDownbar(place) {
    currentPlace = place;

    // Determina se il luogo è già salvato nei preferiti
    const isSaved = !!place._mapKey;

    // Calcola percorsi ORS solo se non li abbiamo già
    try {
        const modes = ["foot-walking", "cycling-regular", "driving-car"];
        let infoStr = "";

        for (const mode of modes) {
            const coords = [
                [place.lng, place.lat],
                [place.lng + 0.01, place.lat + 0.01] // Esempio: destinazione leggermente spostata
            ];
            const resp = await fetch(`https://api.openrouteservice.org/v2/directions/${mode}`, {
                method: "POST",
                headers: {
                    "Authorization": ORS_API_KEY,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ coordinates: coords })
            });
            const routesData = await resp.json();
            if (routesData.features && routesData.features[0]) {
                const summary = routesData.features[0].properties.summary;
                const dist = (summary.distance / 1000).toFixed(2);
                const dur = Math.ceil(summary.duration / 60);
                infoStr += `${mode.replace("-", " ")}: ${dist} km, ${dur} min<br>`;
            } else {
                infoStr += `${mode.replace("-", " ")}: percorso non disponibile<br>`;
            }
        }
        place.info = infoStr;
    } catch (e) {
        console.warn("ORS error:", e);
        place.info = "Impossibile calcolare percorsi";
    }

    // Costruisci HTML del downbar
    let html = `<h3 style="margin:0 0 6px 0">${escapeHtml(place.name)}</h3>`;
    if (place.address) html += `<div style="color:var(--muted);font-size:13px">${escapeHtml(place.address)}</div>`;
    if (place.photo) html += `<img src="${escapeHtml(place.photo)}" class="place-photo" loading="lazy">`;
    else html += `<img src="https://source.unsplash.com/800x400/?${encodeURIComponent((place.name || 'luogo').split(',')[0])}" class="place-photo" loading="lazy">`;
    if (place.info) html += `<div style="margin-top:8px;font-size:14px">${place.info}</div>`;

    downbarInner.innerHTML = html;

    // Aggiorna bottone preferiti
    addFavBtn.textContent = isSaved ? 'Rimuovi dai preferiti' : 'Aggiungi ai preferiti';
    downbar.classList.add('open');
    downbar.setAttribute('aria-hidden', 'false');
}

// Chiusura downbar
downbarClose.addEventListener('click', () => {
    downbar.classList.remove('open');
    downbar.setAttribute('aria-hidden', 'true');
});

// Bottone aggiungi/rimuovi dai preferiti
addFavBtn.addEventListener('click', async () => {
    if (!currentPlace) return showToast('Nessun luogo selezionato');

    try {
        const userDocRef = db.collection('users').doc(auth.currentUser.uid);
        const userSnap = await userDocRef.get();
        let Maps = userSnap.exists && userSnap.data().Maps ? userSnap.data().Maps : {};

        if (currentPlace._mapKey) {
            // Rimuovi dai preferiti
            delete Maps[currentPlace._mapKey];
            currentPlace._mapKey = null;
        } else {
            // Aggiungi ai preferiti
            const newKey = Date.now().toString();
            Maps[newKey] = { name: currentPlace.name, lat: currentPlace.lat, lng: currentPlace.lng, address: currentPlace.address || '', photo: currentPlace.photo || '', info: currentPlace.info || '' };
            currentPlace._mapKey = newKey;
        }

        await userDocRef.set({ Maps }, { merge: true });
        await loadFavorites(); // Aggiorna lista nella sidebar
        showDownbar(currentPlace); // Ricarica downbar aggiornata
    } catch (e) {
        console.error("Errore salvataggio:", e);
        showToast("Errore salvataggio luogo.");
    }
});

/* ---------- ROUTE CALCULATION (ORS) - walking / cycling / driving only ---------- */
async function computeAndShowRoutes(){
  if(!currentPlace) return showToast('Seleziona prima un luogo');
  if(!navigator.geolocation) return showToast('Abilita la geolocalizzazione');
  navigator.geolocation.getCurrentPosition(async pos => {
    const start = [pos.coords.longitude, pos.coords.latitude];
    const end = [currentPlace.lng, currentPlace.lat];
    if(!isFinite(end[0]) || !isFinite(end[1])) return showToast('Coordinate destinazione non disponibili');

    // clear previous
    clearRoutes();

    if(!ORS_API_KEY) return showToast('ORS non impostata (calcolo percorsi disabilitato)');

    // modes to request
    const modes = [
      {id:'foot-walking', label:'A piedi', color:routeColors['foot-walking'] || routeColors['foot-walking']},
      {id:'cycling-regular', label:'Bici', color:routeColors['cycling-regular'] || routeColors['cycling-regular']},
      {id:'driving-car', label:'Auto', color:routeColors['driving-car'] || routeColors['driving-car']}
    ];

    routeLegend.innerHTML = '';
    const summaryParts = [];

    for(const m of modes){
      try{
        const res = await fetch(`https://api.openrouteservice.org/v2/directions/${m.id}`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': ORS_API_KEY },
          body: JSON.stringify({ coordinates: [start, end] })
        });
        if(!res.ok){
          const text = await res.text();
          console.warn('ORS response not ok', m.id, res.status, text);
          continue;
        }
        const j = await res.json();
        const feat = j.features && j.features[0];
        if(!feat) continue;
        const summary = feat.properties && feat.properties.summary;
        const coords = feat.geometry && feat.geometry.coordinates;
        if(coords && coords.length){
          const latlngs = coords.map(c => [c[1], c[0]]);
          const poly = L.polyline(latlngs, { color: m.color, weight: 5, opacity: 0.9 }).addTo(map);
          routeLayers[m.id] = poly;
          // center/fit to last poly (will result to fit last)
          map.fitBounds(poly.getBounds(), { padding: [50,50] });
        }
        if(summary){
          const distKm = (summary.distance/1000).toFixed(2);
          const durMin = Math.ceil(summary.duration/60);
          summaryParts.push(`${m.label}: ${distKm} km — ${durMin} min`);
          const legendItem = document.createElement('div');
          legendItem.innerHTML = `<span style="display:inline-block;width:12px;height:8px;background:${m.color};margin-right:8px;border-radius:2px"></span>${m.label}`;
          routeLegend.appendChild(legendItem);
        }
      }catch(e){
        console.error('compute route err', e);
      }
    }

    if(summaryParts.length > 0){
      downbarInner.insertAdjacentHTML('beforeend', `<div style="margin-top:10px;font-weight:700">Stime</div><div style="margin-top:6px">${escapeHtml(summaryParts.join('<br>'))}</div>`);
    } else {
      downbarInner.insertAdjacentHTML('beforeend', `<div style="margin-top:10px;color:var(--muted)">Impossibile calcolare percorsi (controlla ORS key o permessi).</div>`);
    }

  }, err => {
    console.error('geolocate err', err);
    showToast('Permessi posizione negati o posizione non disponibile');
  });
}

navBtn.addEventListener('click', computeAndShowRoutes);

clearRoutesBtn.addEventListener('click', ()=> { clearRoutes(); showToast('Tracce rimosse'); });

function clearRoutes(){
  for(const k in routeLayers){
    try{ map.removeLayer(routeLayers[k]); }catch(e){}
  }
  routeLayers = {};
  routeLegend.innerHTML = '';
}

/* ---------- SEARCH (Nominatim) ---------- */
searchBtn.addEventListener('click', doSearch);
searchInput.addEventListener('keydown', (ev)=> { if(ev.key === 'Enter'){ ev.preventDefault(); doSearch(); } });

async function doSearch(){
  const q = (searchInput.value || '').trim();
  if(!q) return showToast('Inserisci cosa cercare');
  try{
    showToast('Ricerca in corso…');
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&q=${encodeURIComponent(q)}`, { headers: { 'Accept-Language':'it' }});
    if(!res.ok) throw new Error('Nominatim error');
    const arr = await res.json();
    if(!arr || arr.length === 0){ showToast('Nessun risultato'); return; }
    const first = arr[0];
    const lat = parseFloat(first.lat), lon = parseFloat(first.lon);
    map.setView([lat, lon], 13);
    const photo = `https://source.unsplash.com/800x400/?${encodeURIComponent(first.display_name.split(',')[0])}`;
    const place = { name: first.display_name, address: first.display_name, lat, lng: lon, photo, info:'', _mapKey: null };
    showDownbar(place);
    sidebarEl.classList.remove('open');
  }catch(e){
    console.error('search err', e);
    showToast('Errore ricerca');
  }
}

/* ---------- UI handlers that depend on user & map ---------- */
function attachUIHandlers(){
  // GPS button
  gpsBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation) return showToast('Geolocalizzazione non supportata');
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setView([pos.coords.latitude, pos.coords.longitude], 15);
      showToast(`Posizione attuale centrata`);
    }, err => showToast('Impossibile ottenere la posizione: ' + err.message));
  });

  // attach map click handler ensured in initMap; nothing else here
}

/* ---------- Helper: when user doc snapshot changed we use renderFavoritesFromMapsField => earlier listener does that. ---------- */

/* ---------- Cleanup ---------- */
window.addEventListener('beforeunload', ()=>{
  if(userDocUnsub) userDocUnsub();
  if(favoritesListenUnsub) favoritesListenUnsub();
  if(overpassController) try{ overpassController.abort(); }catch(e){}
});

/* ----------------- END OF SCRIPT ----------------- */
</script>

</body>
</html>