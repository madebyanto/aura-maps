<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aura Maps</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Firebase 8.10.0 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{--mag:#E515F6;--muted:#8b8b95;--bg:#fff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:#111}
.topbar{position:fixed;top:0;left:0;right:0;height:60px;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 14px;z-index:2000;border-bottom:1px solid rgba(0,0,0,.04)}
.brand{display:flex;align-items:center;gap:12px;font-weight:700;color:var(--mag)}
.hamburger{font-size:22px;cursor:pointer}
.profile-img{width:44px;height:44px;border-radius:999px;object-fit:cover;cursor:pointer;border:2px solid rgba(0,0,0,0.06)}
.sidebar{position:fixed;top:60px;left:12px;bottom:12px;width:320px;max-width:86%;background:#fff;border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(2,6,23,0.06);overflow:auto;transform:translateX(-115%);transition:transform .22s ease;z-index:1800}
.sidebar.open{transform:translateX(0)}
.search-row{display:flex;gap:8px;margin-bottom:8px}
.search-row input{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
.btn{background:var(--mag);color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;font-weight:600}
.small-btn{background:#f6f6fb;border:1px solid #eee;padding:6px 8px;border-radius:10px;cursor:pointer}
#map{position:fixed;top:60px;left:0;right:0;bottom:0;z-index:0}
.downbar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;width:92%;max-width:720px;background:#fff;border-radius:14px;padding:14px;box-shadow:0 12px 40px rgba(2,6,23,0.12);display:none;z-index:2200}
.downbar.open{display:block}
.downbar .close{position:absolute;right:12px;top:8px;background:none;border:0;font-size:18px;cursor:pointer;color:var(--mag)}
.place-photo{width:100%;height:180px;object-fit:cover;border-radius:10px;margin-top:8px}
.fav-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;background:#fbfbff;border:1px solid #eee;margin-bottom:8px}
.fav-item .title{font-weight:600;color:var(--mag);cursor:pointer}
.fav-actions{display:flex;gap:8px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:rgba(0,0,0,.8);color:#fff;padding:8px 12px;border-radius:10px;display:none;z-index:3000}
.toggle-row{display:flex;align-items:center;gap:8px;margin:8px 0}
.toggle-row label{font-size:14px;color:var(--muted)}
@media(max-width:720px){.sidebar{width:92%;left:4%}.downbar{left:6px;transform:none;width:calc(100% - 12px)}}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand"><span id="hamburger" class="hamburger">☰</span><span>AuraMaps</span></div>
  <!-- id profile-img esattamente come richiesto -->
  <img id="profile-img" class="profile-img" src="default-profile.png" alt="Immagine del profilo">
</header>

<aside id="sidebar" class="sidebar" aria-hidden="true">
  <h3>Ricerca & Preferiti</h3>

  <div class="search-row">
    <input id="searchInput" type="search" placeholder="Cerca città, indirizzo o luogo..." />
    <button id="searchBtn" class="btn">Cerca</button>
  </div>

  <div style="margin-bottom:6px">
    <button id="gpsBtn" class="btn" style="width:100%;">Mostra dove sei</button>
  </div>

  <div class="toggle-row">
    <label for="poiToggle">Mostra POI</label>
    <input id="poiToggle" type="checkbox">
    <span id="poiToggleLabel" style="margin-left:auto;color:var(--muted)">No</span>
  </div>

  <h4>Preferiti</h4>
  <div id="favoritesList" style="margin-bottom:12px"></div>

  <hr style="border:none;height:1px;background:#f1f1f5;margin:12px 0;">
  <div style="font-size:13px;color:var(--muted)">Se non hai un account, crealo su <a href="https://os.aurastudioitalia.it" target="_blank">os.aurastudioitalia.it</a> o scarica Aura+ su Google Play Store.</div>
</aside>

<div id="map"></div>

<div id="downbar" class="downbar" role="dialog" aria-hidden="true">
  <button class="close" id="downbarClose">✖</button>
  <div id="downbarInner"></div>
  <div style="display:flex;gap:10px;margin-top:12px;">
    <button id="addFavBtn" class="btn">Aggiungi ai preferiti</button>
    <button id="navBtn" class="small-btn">Calcola percorso</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ========== CONFIG ========== */
/* Hai fornito questa ORS key; la inserisco qui */
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImUwYzIxYjc2ZmQyNTRiYzY4YTUxNTVlNmIyOGViNDJmIiwiaCI6Im11cm11cjY0In0=";

const firebaseConfig = {
  apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
  authDomain: "myauraid-f03c6.firebaseapp.com",
  projectId: "myauraid-f03c6",
  storageBucket: "myauraid-f03c6.appspot.com",
  messagingSenderId: "190478237725",
  appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
/* ====================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* UI refs */
const profileImg = document.getElementById('profile-img');
const hamburger = document.getElementById('hamburger');
const sidebar = document.getElementById('sidebar');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const gpsBtn = document.getElementById('gpsBtn');
const favoritesList = document.getElementById('favoritesList');
const downbar = document.getElementById('downbar');
const downbarInner = document.getElementById('downbarInner');
const downbarClose = document.getElementById('downbarClose');
const addFavBtn = document.getElementById('addFavBtn');
const navBtn = document.getElementById('navBtn');
const toast = document.getElementById('toast');
const poiToggle = document.getElementById('poiToggle');
const poiToggleLabel = document.getElementById('poiToggleLabel');

let currentUser = null;
let map = null;
let poiMarkers = [];
let currentPlace = null;
let favoritesUnsub = null;
let overpassController = null;
let showPOI = (localStorage.getItem('aura_show_poi') === '1');

/* helpers */
function showToast(msg, ms=2200){ toast.textContent = msg; toast.style.display = 'block'; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display='none', ms); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function sanitizePlace(place){
  return {
    name: String(place.name || '').slice(0, 200),
    lat: Number(place.lat || place.latitude || 0),
    lng: Number(place.lng || place.longitude || place.lon || 0),
    address: String(place.address || '').slice(0, 500),
    photo: String(place.photo || '').slice(0, 1000),
    info: String(place.info || '').slice(0, 2000)
  };
}

/* AUTH check */
auth.onAuthStateChanged(async (u)=>{
  if(!u){ window.location.href='index.html'; return; }
  currentUser = u;
  await loadProfileImage();        // setta profile-img.src correttamente
  initMap();
  attachFavoritesListener();
  poiToggle.checked = showPOI;
  poiToggleLabel.textContent = showPOI ? 'Sì' : 'No';
});

/* PROFILE IMAGE: prendi stringa da users/{UID}/profileImage */
async function loadProfileImage(){
  try{
    const docRef = db.collection('users').doc(currentUser.uid);
    const snap = await docRef.get();
    if(!snap.exists){
      // crea doc minimale
      await docRef.set({ profileImage: "https://aurastudioitalia.it/antogalaxyavatar.png" }, { merge:true });
      profileImg.src = "https://aurastudioitalia.it/antogalaxyavatar.png";
      return;
    }
    const data = snap.data() || {};
    // imposta src ESATTAMENTE con la stringa in profileImage (fallback)
    profileImg.src = (typeof data.profileImage === 'string' && data.profileImage.trim().length) ? data.profileImage : "https://aurastudioitalia.it/antogalaxyavatar.png";
  }catch(e){
    console.error('loadProfileImage err', e);
    profileImg.src = "https://aurastudioitalia.it/antogalaxyavatar.png";
  }
}
profileImg.addEventListener('error', ()=> { profileImg.src = "https://aurastudioitalia.it/antogalaxyavatar.png"; });
profileImg.addEventListener('click', ()=> alert("Per gestire il tuo profilo, vai su os.aurastudioitalia.it o scarica Aura+ su Google Play Store."));

/* SIDEBAR toggle */
hamburger.addEventListener('click', ()=> sidebar.classList.toggle('open'));

/* POI toggle persistente */
poiToggle.addEventListener('change', ()=>{
  showPOI = poiToggle.checked;
  localStorage.setItem('aura_show_poi', showPOI ? '1':'0');
  poiToggleLabel.textContent = showPOI ? 'Sì' : 'No';
  if(!showPOI) clearPOIMarkers();
  else if(map && map.getZoom() >= 13) loadPOI();
});

/* MAP init */
function initMap(){
  if(map) return;
  map = L.map('map', { zoomControl:false }).setView([45.4642, 9.19], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap contributors' }).addTo(map);

  // load POI on moveend, throttle; only when showPOI true and zoom >=13
  map.on('moveend', debounce(()=> {
    if(!showPOI) return;
    if(map.getZoom() < 13){ clearPOIMarkers(); return; }
    const b = map.getBounds();
    const latSpan = Math.abs(b.getNorth() - b.getSouth());
    const lngSpan = Math.abs(b.getEast() - b.getWest());
    if(latSpan > 1.4 || lngSpan > 2.0){ clearPOIMarkers(); showToast('Avvicinati per caricare POI'); return; }
    loadPOI();
  }, 700));

  map.on('click', async (e)=>{
    try{
      const lat = e.latlng.lat, lon = e.latlng.lng;
      const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      if(!resp.ok) throw new Error('Reverse failed');
      const data = await resp.json();
      const name = data.display_name || `Posizione ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      const place = { name, address: data.display_name || '', lat, lng: lon, photo:'', info:'', isFavorite:false };
      showDownbar(place);
    }catch(err){
      console.error('map click err', err);
      showToast('Errore lettura posizione');
    }
  });
}

/* clear POI & abort */
function clearPOIMarkers(){
  poiMarkers.forEach(m => { try{ map.removeLayer(m); }catch(e){} });
  poiMarkers = [];
  if(overpassController){ try{ overpassController.abort(); }catch(e){} overpassController = null; }
}

/* load POI using Overpass (throttled + abortable) */
async function loadPOI(){
  if(!showPOI) return;
  clearPOIMarkers();
  const b = map.getBounds();
  const s = b.getSouth(), w = b.getWest(), n = b.getNorth(), e = b.getEast();
  if(Math.abs(n - s) > 1.4 || Math.abs(e - w) > 2.0){ showToast('Area troppo ampia per POI'); return; }

  const q = `[out:json][timeout:20];
(
  node["amenity"~"restaurant|cafe|bar|fast_food|hotel|pub|bakery|supermarket|pharmacy"](${s},${w},${n},${e});
  way["amenity"~"restaurant|cafe|bar|fast_food|hotel|pub|bakery|supermarket|pharmacy"](${s},${w},${n},${e});
);
out center 120;`;

  overpassController = new AbortController();
  try{
    const res = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body: q, signal: overpassController.signal });
    if(!res.ok) throw new Error('Overpass error');
    const json = await res.json();
    const elements = json.elements || [];
    elements.slice(0,120).forEach(el => {
      const lat = el.lat || (el.center && el.center.lat);
      const lon = el.lon || (el.center && el.center.lon);
      if(!lat || !lon) return;
      const tags = el.tags || {};
      const name = tags.name || '(Senza nome)';
      const address = [tags['addr:street'], tags['addr:housenumber'], tags['addr:city']].filter(Boolean).join(' ');
      const marker = L.marker([lat, lon]).addTo(map);
      poiMarkers.push(marker);
      marker.on('click', ()=> {
        const place = { name, address, lat, lng:lon, photo:'', info:'Recensioni non disponibili', isFavorite:false };
        showDownbar(place);
      });
    });
  }catch(err){
    if(err.name === 'AbortError'){ console.log('Overpass aborted'); return; }
    console.warn('loadPOI err', err);
  }finally{ overpassController = null; }
}

/* FAVORITES listener (subcollection users/{uid}/Maps) */
function attachFavoritesListener(){
  const colRef = db.collection('users').doc(currentUser.uid).collection('Maps').orderBy('timestamp','desc');
  if(favoritesUnsub) favoritesUnsub();
  favoritesUnsub = colRef.onSnapshot(snapshot=>{
    favoritesList.innerHTML = '';
    if(snapshot.empty){ favoritesList.innerHTML = '<div style="color:var(--muted);padding:8px">Nessun preferito</div>'; return; }
    snapshot.forEach(doc => {
      const id = doc.id;
      const data = doc.data();
      const luogo = data.luogo || data;
      const item = document.createElement('div'); item.className='fav-item';
      item.innerHTML = `<div style="flex:1"><div class="title">${escapeHtml(luogo.name || 'Luogo')}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(luogo.address || '')}</div></div>
        <div class="fav-actions"><button class="small-btn" data-go="${id}" data-lat="${luogo.lat}" data-lng="${luogo.lng}">Vai</button>
        <button class="small-btn" data-del="${id}" style="background:#ffecec;border:1px solid #f0c0c0;color:#c00">Elimina</button></div>`;
      favoritesList.appendChild(item);
      item.querySelector('[data-go]')?.addEventListener('click', (ev)=> {
        const lat = parseFloat(ev.currentTarget.dataset.lat), lng = parseFloat(ev.currentTarget.dataset.lng);
        map.setView([lat,lng],15);
      });
      item.querySelector('[data-del]')?.addEventListener('click', async (ev)=> {
        const idToDel = ev.currentTarget.dataset.del;
        if(!confirm('Eliminare questo preferito?')) return;
        try{ await db.collection('users').doc(currentUser.uid).collection('Maps').doc(idToDel).delete(); showToast('Preferito eliminato'); }catch(e){ console.error(e); showToast('Errore eliminazione'); }
      });
      item.querySelector('.title')?.addEventListener('click', ()=>{
        const lat = parseFloat(item.querySelector('[data-go]').dataset.lat), lng = parseFloat(item.querySelector('[data-go]').dataset.lng);
        const place = { name:luogo.name, address: luogo.address||'', lat, lng, photo:luogo.photo||'', info:luogo.info||'', isFavorite:true, _id:id };
        map.setView([lat,lng],15);
        showDownbar(place);
      });
    });
  }, err => console.error('favorites listener', err));
}

/* ADD favorite sanitized */
async function addFavorite(place){
  if(!place) return showToast('Nessun luogo selezionato');
  const p = sanitizePlace(place);
  if(!isFinite(p.lat) || !isFinite(p.lng) || !p.name) return showToast('Luogo non valido');
  try{
    // salva nella sottocollezione Maps -> documento con campo "luogo"
    const doc = { luogo: p, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection('users').doc(currentUser.uid).collection('Maps').add(doc);
    showToast('Preferito aggiunto');
  }catch(e){
    console.error('addFavorite error', e);
    // messaggio utile: se permission-denied probabilmente regole Firestore
    const msg = e && e.message ? e.message : 'Errore salvataggio';
    showToast('Errore salvataggio: ' + msg, 5000);
  }
}

/* DOWNBAR show/close */
function showDownbar(place){
  currentPlace = place;
  let html = `<h3 style="margin:0 0 6px 0">${escapeHtml(place.name)}</h3>`;
  if(place.address) html += `<div style="color:var(--muted);font-size:13px">${escapeHtml(place.address)}</div>`;
  if(place.category) html += `<div style="font-size:13px;margin-top:6px">Categoria: ${escapeHtml(place.category)}</div>`;
  if(place.photo) html += `<img src="${escapeHtml(place.photo)}" class="place-photo" loading="lazy">`;
  else html += `<img src="https://source.unsplash.com/800x400/?${encodeURIComponent(place.name)}" class="place-photo" loading="lazy">`;
  if(place.info) html += `<div style="margin-top:8px;font-size:14px">${place.info}</div>`;
  downbarInner.innerHTML = html;
  downbar.classList.add('open'); downbar.setAttribute('aria-hidden','false');
}
downbarClose.addEventListener('click', ()=> { downbar.classList.remove('open'); downbar.setAttribute('aria-hidden','true'); });

addFavBtn.addEventListener('click', async ()=> {
  if(!currentPlace) return showToast('Nessun luogo selezionato');
  await addFavorite(currentPlace);
});

/* NAV (ORS estimates) */
navBtn.addEventListener('click', ()=> {
  if(!currentPlace) return showToast('Seleziona prima un luogo');
  if(!navigator.geolocation) return showToast('Abilita la geolocalizzazione');
  navigator.geolocation.getCurrentPosition(async pos=>{
    if(!ORS_API_KEY) return showToast('ORS non impostata');
    const start = [pos.coords.longitude, pos.coords.latitude];
    const end = [currentPlace.lng || currentPlace.lon, currentPlace.lat];
    const modes = [{id:'foot-walking',label:'A piedi',emoji:'🚶'},{id:'cycling-regular',label:'Bici',emoji:'🚴'},{id:'driving-car',label:'Auto',emoji:'🚗'}];
    let infoHtml = '<div style="margin-top:8px;font-weight:700">Stime percorso</div>';
    for(const m of modes){
      try{
        const r = await fetch(`https://api.openrouteservice.org/v2/directions/${m.id}`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': ORS_API_KEY },
          body: JSON.stringify({ coordinates: [start, end] })
        });
        if(!r.ok) { console.warn('ORS r fail', await r.text()); continue; }
        const j = await r.json();
        const s = j.features && j.features[0] && j.features[0].properties && j.features[0].properties.summary;
        if(s){
          const dist = (s.distance/1000).toFixed(2);
          const dur = Math.ceil(s.duration/60);
          infoHtml += `<div style="margin-top:6px">${m.emoji} ${m.label}: ${dist} km — ${dur} min</div>`;
        }
      }catch(e){ console.warn('ORS route error', e); }
    }
    downbarInner.insertAdjacentHTML('beforeend', infoHtml);
  }, err => showToast('Permessi posizione negati'));
});

/* SEARCH (Nominatim) */
searchBtn.addEventListener('click', doSearch);
searchInput.addEventListener('keydown', (ev)=> { if(ev.key === 'Enter'){ ev.preventDefault(); doSearch(); } });

async function doSearch(){
  const q = (searchInput.value || '').trim();
  if(!q) return showToast('Inserisci cosa cercare');
  try{
    showToast('Ricerca in corso…');
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&q=${encodeURIComponent(q)}`, { headers:{ 'Accept-Language': 'it' }});
    if(!res.ok) throw new Error('Nominatim error');
    const arr = await res.json();
    if(!arr || arr.length === 0){ showToast('Nessun risultato'); return; }
    const first = arr[0];
    const lat = parseFloat(first.lat), lon = parseFloat(first.lon);
    map.setView([lat, lon], 13);
    const photo = `https://source.unsplash.com/800x400/?${encodeURIComponent(first.display_name.split(',')[0])}`;
    let info = '';
    if(ORS_API_KEY){
      try{
        const center = map.getCenter();
        const coords = [[center.lng, center.lat], [lon, lat]];
        const modes = ['foot-walking','cycling-regular','driving-car'];
        for(const m of modes){
          try{
            const r = await fetch(`https://api.openrouteservice.org/v2/directions/${m}`, {
              method:'POST',
              headers:{ 'Content-Type':'application/json', 'Authorization': ORS_API_KEY },
              body: JSON.stringify({ coordinates: coords })
            });
            if(!r.ok) continue;
            const j = await r.json();
            const s = j.features && j.features[0] && j.features[0].properties && j.features[0].properties.summary;
            if(s){ info += `${m.replace('-',' ')}: ~${Math.ceil(s.duration/60)} min • `; }
          }catch(e){/* ignore */ }
        }
      }catch(e){ console.warn('ORS quick', e); }
    }
    const place = { name: first.display_name, address: first.display_name, lat, lng: lon, photo, info, isFavorite:false };
    showDownbar(place);
    sidebar.classList.remove('open');
  }catch(e){ console.error('search err', e); showToast('Errore ricerca'); }
}

/* cleanup */
window.addEventListener('beforeunload', ()=> { if(favoritesUnsub) favoritesUnsub(); if(overpassController) try{ overpassController.abort(); }catch(e){} });

/* debounce util */
function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }
</script>

</body>
</html>