<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aura Maps</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body,html{height:100%;font-family:'Poppins',sans-serif;}
#map{height:100vh;width:100vw;}
#topbar{position:fixed;top:0;left:0;right:0;height:50px;background:white;display:flex;align-items:center;justify-content:space-between;padding:0 15px;box-shadow:0 2px 5px rgba(0,0,0,0.15);z-index:1000;border-radius:0 0 10px 10px;}
#menu-btn,#gps-btn{font-size:24px;cursor:pointer;}
#profile-btn{width:40px;height:40px;border-radius:50%;cursor:pointer;object-fit:cover;}
#sidebar{position:fixed;top:50px;left:-260px;width:260px;height:calc(100% - 50px);background:white;box-shadow:2px 0 5px rgba(0,0,0,0.2);transition:0.3s;padding:15px;border-radius:0 10px 10px 0;z-index:999;overflow-y:auto;}
#sidebar.active{left:0;}
#downbar{position:fixed;bottom:-400px;left:10px;right:10px;background:white;padding:15px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.2);transition:0.3s;z-index:1000;}
#downbar.active{bottom:20px;}
#downbar-close{float:right;cursor:pointer;font-weight:bold;}
.favorite-btn{background:#E515F6;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;margin-top:5px;}
#search-input{position:fixed;top:10px;left:60px;width:200px;z-index:1000;padding:5px;border-radius:5px;border:1px solid #ddd;}
ul{list-style:none;}
li{margin:8px 0;cursor:pointer;color:#E515F6;}
#gps-btn{margin-left:10px;}
</style>
</head>
<body>

<div id="topbar">
  <div>
    <span id="menu-btn">&#9776;</span>
    <span id="gps-btn">&#128205;</span>
  </div>
  <img id="profile-btn" src="placeholder.png" alt="Profile">
</div>

<div id="sidebar">
  <h3>Preferiti</h3>
  <ul id="favorites-list"></ul>
</div>

<div id="downbar">
  <div id="downbar-close">X</div>
  <div id="downbar-content"></div>
</div>

<div id="map"></div>
<input type="text" id="search-input" placeholder="Cerca cittÃ  o luogo">

<script>
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImUwYzIxYjc2ZmQyNTRiYzY4YTUxNTVlNmIyOGViNDJmIiwiaCI6Im11cm11cjY0In0=";
const firebaseConfig = {
    apiKey:"AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
    authDomain:"myauraid-f03c6.firebaseapp.com",
    projectId:"myauraid-f03c6",
    storageBucket:"myauraid-f03c6.appspot.com",
    messagingSenderId:"190478237725",
    appId:"1:190478237725:web:0d39907473f511b85a06f4"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

// check login
auth.onAuthStateChanged(async user=>{
    if(!user){window.location.href="index.html";return;}

    // load profile image
    const profileBtn=document.getElementById('profile-btn');
    try{
        const doc=await db.collection('users').doc(user.uid).get();
        const data=doc.exists?doc.data():{};
        if(data.profileImage) profileBtn.src=data.profileImage;
    }catch(e){console.warn(e);}
    profileBtn.onclick=()=>alert("Per gestire il tuo profilo, vai su os.aurastudioitalia.it o scarica Aura+ su Google Play Store.");

    // init map
    const map=L.map('map',{zoomControl:false}).setView([45.4642,9.19],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    const sidebar=document.getElementById('sidebar');
    document.getElementById('menu-btn').onclick=()=>sidebar.classList.toggle('active');

    const gpsBtn=document.getElementById('gps-btn');
    gpsBtn.onclick=()=>{
        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(pos=>{
                map.setView([pos.coords.latitude,pos.coords.longitude],15);
            });
        }else alert("Geolocalizzazione non supportata.");
    };

    const downbar=document.getElementById('downbar');
    const downbarContent=document.getElementById('downbar-content');
    document.getElementById('downbar-close').onclick=()=>downbar.classList.remove('active');

    const favListEl=document.getElementById('favorites-list');
    async function loadFavorites(){
        favListEl.innerHTML='';
        const doc=await db.collection('users').doc(user.uid).get();
        const data=doc.exists?doc.data():{};
        if(!data.Maps) data.Maps={};
        for(const key in data.Maps){
            const place=data.Maps[key];
            const li=document.createElement('li');
            li.textContent=place.name;
            li.onclick=()=>{map.setView([place.lat,place.lng],14); showDownbar(place);}
            favListEl.appendChild(li);
        }
    }
    await loadFavorites();

    function showDownbar(place){
        let html=`<h4>${place.name}</h4>`;
        if(place.address) html+=`<p>${place.address}</p>`;
        if(place.photo) html+=`<img src="${place.photo}" style="width:100%;border-radius:5px;margin:5px 0;">`;
        if(place.info) html+=`<p>${place.info}</p>`;
        html+=`<button class="favorite-btn">Aggiungi ai preferiti</button>`;
        downbarContent.innerHTML=html;
        downbar.classList.add('active');

        const btn=downbarContent.querySelector('.favorite-btn');
        btn.onclick=async()=>{
            const docRef=db.collection('users').doc(user.uid);
            const userDoc=await docRef.get();
            let Maps=userDoc.exists&&userDoc.data().Maps?userDoc.data().Maps:{};
            Maps[Date.now()]={name:place.name,lat:place.lat,lng:place.lng,address:place.address,photo:place.photo,info:place.info};
            await docRef.set({Maps},{merge:true});
            await loadFavorites();
            alert("Aggiunto ai preferiti!");
        };
    }

    // search cities/places
    const searchInput=document.getElementById('search-input');
    searchInput.addEventListener('keypress',async e=>{
        if(e.key==='Enter'){
            const q=searchInput.value;
            const resp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
            const data=await resp.json();
            if(data.length>0){
                const first=data[0];
                const lat=parseFloat(first.lat),lng=parseFloat(first.lon);
                map.setView([lat,lng],13);

                // Mapillary photo
                let photoUrl="";
                try{
                    const mapResp=await fetch(`https://graph.mapillary.com/images?access_token=${ORS_API_KEY}&fields=thumb_1024&closeto=${lng},${lat}&limit=1`);
                    const mapData=await mapResp.json();
                    if(mapData.data&&mapData.data.length>0) photoUrl=mapData.data[0].thumb_1024;
                }catch(e){console.warn("Mapillary error",e);}

                // Route info dummy (puoi sostituire con ORS reale)
                let infoStr=`Coordinate: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;

                showDownbar({name:first.display_name,lat,lng,address:first.display_name,photo:photoUrl,info:infoStr});
                sidebar.classList.remove('active');
            }
        }
    });

    // click map to add favorite manually
    map.on('click',async e=>{
        const lat=e.latlng.lat,lng=e.latlng.lng;
        // reverse geocode
        const resp=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data=await resp.json();
        const name=data.address && data.address.city?data.address.city:data.display_name||"Luogo";
        showDownbar({name:name,lat,lng,address:data.display_name||"",photo:"",info:`Coordinate: ${lat.toFixed(5)}, ${lng.toFixed(5)}`});
    });

});
</script>
</body>
</html>