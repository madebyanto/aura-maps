<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aura Maps ‚Äî Free</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase 8.10.0 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
:root{
  --accent:#E515F6; --bg:#fff; --text:#111; --border:#e6e6ee; --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);overflow:hidden}
.topbar{
  height:56px; display:flex; align-items:center; justify-content:space-between;
  padding:0 12px; background:#fff; border-bottom:1px solid var(--border);
}
.toggleSidebar{font-size:22px; color:var(--accent); cursor:pointer; user-select:none}
.profileWrap{width:44px;height:44px;display:flex;align-items:center;justify-content:center}
.profile{width:40px;height:40px;border-radius:999px;object-fit:cover;border:2px solid rgba(0,0,0,0.04);cursor:pointer}

.layout { position:relative; height:calc(100% - 56px); }

/* Sidebar */
.sidebar{
  position:absolute; top:12px; left:12px; bottom:12px; width:320px; max-width:86%;
  background:#fff; border-radius:var(--radius); padding:12px; box-shadow:0 8px 30px rgba(2,6,23,0.06);
  overflow:auto; z-index:1400; transform:translateX(0); transition:transform .22s ease;
}
@media(min-width:1025px){
  .sidebar{ left:12px; top:68px; bottom:12px; width:340px; }
}
.sidebarHidden{ transform: translateX(-110%); }
.sidebar h3{ margin:6px 0; color:var(--accent) }

/* Inputs / buttons */
.input, .btn{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); font-size:14px;
}
.btn{ background:var(--accent); color:#fff; border:0; cursor:pointer; font-weight:600 }
.smallBtn{ display:inline-block; padding:8px 10px; border-radius:10px; background:#f5f5f7; border:1px solid var(--border); cursor:pointer; }

/* Map */
#map{ position:absolute; inset:56px 0 0 0; height:calc(100% - 56px); width:100%; }

/* Places list */
.place-item{
  display:flex; gap:8px; align-items:center; justify-content:space-between;
  padding:10px; border-radius:10px; background:#fbfbfd; border:1px solid var(--border); margin-bottom:8px;
}
.place-left{ display:flex; gap:8px; align-items:center; }
.place-title{ font-weight:600; font-size:14px; color:var(--text); }
.place-actions{ display:flex; gap:8px; align-items:center; }

/* Downbar */
.downbar{
  position:fixed; left:12px; right:12px; bottom:12px; z-index:1500;
  background:#fff; border-radius:14px; padding:12px; box-shadow:0 12px 40px rgba(2,6,23,0.08);
  display:none; max-height:48vh; overflow:auto;
}
.downbar .closeBtn{ position:absolute; right:14px; top:10px; cursor:pointer; color:var(--accent); font-weight:700 }
.downbar img{ width:100%; border-radius:10px; margin-top:8px; object-fit:cover; max-height:180px; }

/* toast small */
.toast{
  position:fixed; left:50%; transform:translateX(-50%); bottom:84px;
  background:rgba(10,10,10,0.9); color:#fff; padding:8px 12px; border-radius:10px; font-size:14px; display:none; z-index:1600;
}

/* responsive tweaks */
@media(max-width:720px){
  .sidebar{ width:88%; left:6%; top:70px; bottom:12px; }
  #map{ inset:56px 0 0 0; }
  .downbar{ left:8px; right:8px; bottom:8px; }
}
</style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <span class="toggleSidebar" id="hamburger">‚ò∞</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="profileWrap">
        <img id="profileImg" class="profile" src="" alt="profile">
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- Sidebar (closed on small screens by default) -->
    <aside id="sidebar" class="sidebar">
      <h3>Cerca citt√†</h3>
      <input id="searchInput" class="input" placeholder="Es. Napoli, Via Roma..." />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="searchBtn" class="btn">Cerca</button>
        <button id="gpsBtn" class="smallBtn">üìç Usa GPS</button>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)">

      <h3>I tuoi preferiti</h3>
      <div id="placesList"></div>
    </aside>

    <!-- Map -->
    <div id="map"></div>

    <!-- Downbar -->
    <div id="downbar" class="downbar" role="dialog" aria-hidden="false">
      <span class="closeBtn" id="downbarClose">‚úñ</span>
      <h3 id="cityName">‚Äî</h3>
      <p id="cityInfo" style="color:#666;margin:6px 0;font-size:14px"></p>
      <img id="cityImg" src="" alt="foto citt√†">
      <p id="cityStats" style="margin-top:10px;font-weight:600"></p>
    </div>

    <div id="toast" class="toast"></div>
  </div>

<script>
/* CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
  authDomain: "myauraid-f03c6.firebaseapp.com",
  projectId: "myauraid-f03c6",
  storageBucket: "myauraid-f03c6.appspot.com",
  messagingSenderId: "190478237725",
  appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImUwYzIxYjc2ZmQyNTRiYzY4YTUxNTVlNmIyOGViNDJmIiwiaCI6Im11cm11cjY0In0="; // metti la tua key ORS qui

/* INIT */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let user = null;
let userLocation = null;
let currentPopupMarker = null;

/* MAP */
const map = L.map('map', { zoomControl:false }).setView([40.85,14.27], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

/* UI refs */
const sidebar = document.getElementById('sidebar');
const hamburger = document.getElementById('hamburger');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const gpsBtn = document.getElementById('gpsBtn');
const placesList = document.getElementById('placesList');
const profileImg = document.getElementById('profileImg');
const downbar = document.getElementById('downbar');
const downbarClose = document.getElementById('downbarClose');
const cityName = document.getElementById('cityName');
const cityInfo = document.getElementById('cityInfo');
const cityImg = document.getElementById('cityImg');
const cityStats = document.getElementById('cityStats');
const toastEl = document.getElementById('toast');

/* small helpers */
function showToast(t){
  toastEl.textContent = t;
  toastEl.style.display = 'block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toastEl.style.display='none', 2200);
}
function closeSidebar(){ sidebar.classList.add('sidebarHidden'); }
function openSidebar(){ sidebar.classList.remove('sidebarHidden'); }

/* toggle sidebar (hamburger) */
hamburger.addEventListener('click', ()=> {
  if(sidebar.classList.contains('sidebarHidden')) openSidebar(); else closeSidebar();
});

/* downbar close */
downbarClose.addEventListener('click', ()=> downbar.style.display = 'none');

/* GPS */
gpsBtn.addEventListener('click', requestLocation);
function requestLocation(){
  if(!navigator.geolocation){ alert('GPS non supportato'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    userLocation = [pos.coords.latitude, pos.coords.longitude];
    showToast('Posizione rilevata');
    gpsBtn.textContent = 'Mostra dove sei';
    map.setView(userLocation, 14);
    L.circleMarker(userLocation, { radius:7, color: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#E515F6' }).addTo(map).bindPopup('Sei qui').openPopup();
  }, err=> showToast('Permessi posizione negati'));
}

/* AUTH */
auth.onAuthStateChanged(u => {
  if(!u){ window.location.href = 'index.html'; return; }
  user = u;
  // read profileImage URL string from Firestore (users/{uid}.profileImage)
  db.collection('users').doc(user.uid).get()
    .then(doc => {
      if(doc.exists && doc.data().profileImage){
        profileImg.src = doc.data().profileImage;
      } else {
        // fallback avatar (SVG data URL or local img)
        profileImg.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect fill="%23f6f6f9" width="100%" height="100%"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="40" fill="%23d0d0d8">A</text></svg>';
      }
    }).catch(e => {
      console.error('caricamento profileImage', e);
    });

  // start listening favorite places
  attachFavoritesListener();
});

/* FAVORITES: add & read & remove */
/* Save a favorite place: creates a doc in users/{UID}/Maps with luogo:{name,lat,lon}, favorite:true */
async function saveFavoritePlaceObj(name, lat, lon){
  if(!user) return showToast('Devi essere loggato');
  try{
    await db.collection('users').doc(user.uid).collection('Maps').add({
      luogo: { name: name, lat: lat, lon: lon },
      favorite: true,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    showToast('Aggiunto ai preferiti');
  } catch(e){ console.error(e); showToast('Errore salvataggio'); }
}

/* Attach real-time listener */
let favUnsub = null;
function attachFavoritesListener(){
  if(favUnsub) favUnsub();
  favUnsub = db.collection('users').doc(user.uid).collection('Maps')
    .where('favorite','==',true)
    .orderBy('timestamp','desc')
    .onSnapshot(snap => {
      placesList.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const id = doc.id;
        const name = d.luogo && d.luogo.name ? d.luogo.name : 'Luogo';
        const lat = d.luogo && d.luogo.lat ? d.luogo.lat : null;
        const lon = d.luogo && d.luogo.lon ? d.luogo.lon : null;

        const item = document.createElement('div');
        item.className = 'place-item';

        const left = document.createElement('div'); left.className = 'place-left';
        const title = document.createElement('div'); title.className = 'place-title'; title.textContent = name;
        left.appendChild(title);

        const actions = document.createElement('div'); actions.className = 'place-actions';
        const goBtn = document.createElement('button'); goBtn.className = 'smallBtn'; goBtn.textContent = 'Vai';
        goBtn.onclick = ()=> { if(lat && lon) map.setView([lat,lon],14); };

        const delBtn = document.createElement('button'); delBtn.className = 'smallBtn'; delBtn.textContent = 'Elimina';
        delBtn.onclick = async ()=> {
          if(!confirm('Eliminare questo preferito?')) return;
          try{
            await db.collection('users').doc(user.uid).collection('Maps').doc(id).delete();
            showToast('Preferito eliminato');
          }catch(e){ console.error(e); showToast('Errore eliminazione'); }
        };

        actions.appendChild(goBtn); actions.appendChild(delBtn);
        item.appendChild(left); item.appendChild(actions);
        placesList.appendChild(item);
      });
    }, err => console.error('fav listener', err));
}

/* SEARCH */
searchBtn.addEventListener('click', searchPlace);
searchInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') searchPlace(); });

async function searchPlace(){
  const q = (searchInput.value || '').trim();
  if(!q) return;
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=5`);
    const data = await res.json();
    if(!data || data.length === 0){ showToast('Nessun risultato'); return; }
    const item = data[0];
    const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
    map.setView([lat,lon], 13);

    // remove previous popup marker
    if(currentPopupMarker) { map.removeLayer(currentPopupMarker); currentPopupMarker = null; }

    // create marker with DOM popup (safe, no inline onclick with raw strings)
    const marker = L.marker([lat,lon]).addTo(map);
    currentPopupMarker = marker;

    // create DOM popup content
    const popupDiv = document.createElement('div');
    const title = document.createElement('div'); title.style.fontWeight='700'; title.style.marginBottom='6px';
    title.textContent = item.display_name;
    const favBtn = document.createElement('button'); favBtn.className = 'smallBtn'; favBtn.style.marginRight='6px';
    favBtn.textContent = '‚ù§Ô∏è Aggiungi ai preferiti';
    favBtn.onclick = ()=> saveFavoritePlaceObj(item.display_name, lat, lon);

    const infoBtn = document.createElement('button'); infoBtn.className = 'smallBtn'; infoBtn.textContent = 'Mostra info';
    infoBtn.onclick = ()=> showDownbar(item);

    popupDiv.appendChild(title); popupDiv.appendChild(favBtn); popupDiv.appendChild(infoBtn);

    marker.bindPopup(popupDiv).openPopup();

    // close sidebar automatically on mobile/after search
    closeSidebar();

    showToast('Risultato trovato');
  } catch(e){
    console.error(e);
    showToast('Errore ricerca');
  }
}

/* DOWnBAR: show info and calculate real routes via OpenRouteService */
async function showDownbar(nominItem){
  const lat = parseFloat(nominItem.lat), lon = parseFloat(nominItem.lon);
  cityName.textContent = nom–∏–ΩItem_to_display(nominItem);
  cityInfo.textContent = extractAddressInfo(nominItem);
  // Unsplash quick photo (no key needed)
  cityImg.src = `https://source.unsplash.com/800x400/?${encodeURIComponent(nominItem.display_name)}`;
  cityStats.textContent = 'Calcolo percorsi...';
  downbar.style.display = 'block';
  // if no userLocation yet, ask user to enable
  if(!userLocation){
    cityStats.textContent = 'Concedi accesso GPS per visualizzare percorsi reali verso questo luogo.';
    return;
  }

  const modes = [
    {key:'foot-walking', emoji:'üö∂'},
    {key:'cycling-regular', emoji:'üö¥'},
    {key:'driving-car', emoji:'üöó'}
  ];
  let parts = [];
  for(const m of modes){
    try{
      const body = { coordinates: [ [userLocation[1], userLocation[0]], [lon, lat] ] };
      const r = await fetch(`https://api.openrouteservice.org/v2/directions/${m.key}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': ORS_API_KEY },
        body: JSON.stringify(body)
      });
      const j = await r.json();
      if(j && j.routes && j.routes.length){
        const mins = Math.round(j.routes[0].summary.duration / 60);
        const km = (j.routes[0].summary.distance / 1000).toFixed(1);
        parts.push(`${m.emoji} ${mins} min (${km} km)`);
      }
    }catch(e){
      console.warn('ORS error', e);
    }
  }
  cityStats.textContent = parts.length ? parts.join('  |  ') : 'Percorsi non disponibili';
}

/* small helpers to extract nicer address & display */
function extractAddressInfo(item){
  // try to get address fields (postcode, state, country) from addressdetails if present
  if(item.address){
    const ad = item.address;
    const cap = ad.postcode ? `CAP: ${ad.postcode}` : '';
    const region = ad.state || ad.region || '';
    const country = ad.country || '';
    return [cap, region, country].filter(Boolean).join(' ‚Ä¢ ');
  }
  return `Lat: ${item.lat}, Lon: ${item.lon}`;
}
function nom–∏–ΩItem_to_display(item){
  return item.display_name || (item.address && (item.address.city || item.address.town || item.address.village)) || 'Luogo';
}

/* ensure search result addressdetails included -> we requested addressdetails=1 above, but nominatim may or may not include address on some endpoints */

/* small UX: close downbar if user clicks map */
map.on('click', ()=> { downbar.style.display = 'none'; });

/* Accessibility: allow pressing ESC to close downbar */
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ downbar.style.display='none' }});
</script>
</body>
</html>
