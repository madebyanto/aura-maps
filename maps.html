<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aura Maps Free</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase 8.10.0 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
:root { --accent:#E515F6; --bg:#fff; --text:#111; --border:#ddd; --radius:12px; }
html,body{margin:0;height:100%;font-family:Arial,sans-serif;}
body{overflow:hidden;background:var(--bg);}
.topbar{display:flex;justify-content:space-between;align-items:center;height:50px;padding:0 10px;background:#fff;border-bottom:1px solid var(--border);}
.topbar img.profile{width:36px;height:36px;border-radius:50%;cursor:pointer;}
.toggleSidebar{font-size:24px;color:var(--accent);cursor:pointer;}
.sidebar{position:absolute;top:50px;bottom:0;left:0;width:280px;background:#fff;border-right:1px solid var(--border);
transform:translateX(-100%);transition:0.3s;display:flex;flex-direction:column;padding:10px;overflow-y:auto;z-index:1000;
border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius);}
.sidebar.active{transform:translateX(0);}
.sidebar h3{margin-top:0;color:var(--accent);}
.sidebar input,.sidebar button{margin-top:5px;padding:8px;border-radius:var(--radius);border:1px solid #ccc;}
.sidebar button.action{background:var(--accent);color:#fff;border:none;}
.map{height:calc(100% - 50px);}
#map{width:100%;height:100%;}
.place-item{padding:8px;border:1px solid #ddd;border-radius:var(--radius);margin-bottom:6px;cursor:pointer;background:#fafafa;}
.downbar{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:1px solid var(--border);padding:12px;display:none;z-index:1500;max-height:50%;overflow-y:auto;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);}
.downbar-close{position:absolute;top:5px;right:10px;cursor:pointer;font-weight:bold;color:var(--accent);}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);display:none;z-index:1200;}
.dialog{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:var(--radius);z-index:1300;}
</style>
</head>
<body>

<div class="topbar">
  <span class="toggleSidebar" onclick="toggleSidebar()">‚ò∞</span>
  <img src="auraaccount.png" class="profile" id="profileImg" onclick="showProfilePopup()">
</div>

<div class="sidebar" id="sidebar">
  <h3>Cerca citt√†</h3>
  <input type="text" id="searchInput" placeholder="Es. Napoli">
  <button class="action" onclick="searchPlace()">Cerca</button>
  <h3>I tuoi preferiti</h3>
  <div id="placesList"></div>
  <h3>Azioni rapide</h3>
  <button class="action" id="gpsBtn" onclick="requestLocation()">üìç Usa GPS</button>
</div>

<div class="map">
  <div id="map"></div>
</div>

<div class="downbar" id="downbar">
  <span class="downbar-close" onclick="closeDownbar()">‚úñ</span>
  <h3 id="cityName"></h3>
  <p id="cityInfo"></p>
  <img id="cityImg" src="">
  <p id="cityStats"></p>
</div>

<div class="overlay" id="overlay"></div>
<div class="dialog" id="profilePopup" style="display:none;">
  <p>Per gestire il tuo profilo, vai su <b>os.aurastudioitalia.it</b> o scarica <b>Aura+</b> su Google Play Store.</p>
  <button onclick="closeProfilePopup()">Chiudi</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
  authDomain: "myauraid-f03c6.firebaseapp.com",
  projectId: "myauraid-f03c6",
  storageBucket: "myauraid-f03c6.appspot.com",
  messagingSenderId: "190478237725",
  appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let user = null;
let userLocation = null;
let map = L.map('map',{zoomControl:false}).setView([40.85,14.27],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

function toggleSidebar(){document.getElementById("sidebar").classList.toggle("active");}
function showProfilePopup(){document.getElementById("profilePopup").style.display="block";document.getElementById("overlay").style.display="block";}
function closeProfilePopup(){document.getElementById("profilePopup").style.display="none";document.getElementById("overlay").style.display="none";}
function closeDownbar(){document.getElementById("downbar").style.display="none";}

// LOGIN
auth.onAuthStateChanged(u=>{
  if(!u) window.location.href="index.html";
  user = u;

  // Carica immagine profilo da URL salvato su Firestore
  db.collection("users").doc(user.uid).get().then(doc=>{
    if(doc.exists){
      const data = doc.data();
      if(data.profileImage) document.getElementById("profileImg").src = data.profileImage;
      else console.log("Nessuna immagine profilo");
    }
  }).catch(err=>console.error("Errore caricamento profilo:",err.message));

  loadFavoritePlaces();
});

// GPS
const gpsBtn = document.getElementById("gpsBtn");
function requestLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      userLocation = [pos.coords.latitude,pos.coords.longitude];
      gpsBtn.textContent="Mostra dove sei";
      map.setView(userLocation,15);
      L.marker(userLocation).addTo(map).bindPopup("Sei qui").openPopup();
    });
  }else alert("GPS non supportato");
}

// Salvataggio preferiti
function saveFavoritePlace(name,lat,lon){
  if(!user) return;
  db.collection("users").doc(user.uid).collection("Maps").add({
    luogo:{name,lat,lon},
    favorite:true,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>console.log("Luogo salvato:",name))
  .catch(err=>console.error("Errore:",err.message));
}

// Caricamento preferiti
function loadFavoritePlaces(){
  db.collection("users").doc(user.uid).collection("Maps")
    .where("favorite","==",true)
    .orderBy("timestamp","desc")
    .onSnapshot(snapshot=>{
      const list=document.getElementById("placesList");
      list.innerHTML="";
      snapshot.forEach(doc=>{
        const data=doc.data().luogo;
        const div=document.createElement("div");
        div.className="place-item";
        div.textContent=data.name;
        div.onclick=()=> map.setView([data.lat,data.lon],14);
        list.appendChild(div);
      });
    });
}

// Ricerca citt√† con Nominatim + percorsi OpenRouteService
const ORS_API_KEY = "YOUR_OPENROUTESERVICE_KEY"; // Gratis su https://openrouteservice.org/

function searchPlace(){
  const q = document.getElementById("searchInput").value;
  if(!q) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
    .then(res=>res.json())
    .then(data=>{
      if(data && data.length>0){
        const city = data[0];
        const lat = parseFloat(city.lat);
        const lon = parseFloat(city.lon);
        map.setView([lat,lon],12);

        L.marker([lat,lon]).addTo(map)
          .bindPopup(`<b>${city.display_name}</b><br><button onclick="saveFavoritePlace('${city.display_name}',${lat},${lon})">‚ù§Ô∏è Preferito</button>`)
          .openPopup();

        showDownbar(city);

        // Chiudi automaticamente sidebar
        document.getElementById("sidebar").classList.remove("active");
      } else alert("Nessun risultato trovato");
    });
}

function showDownbar(city){
  const lat=parseFloat(city.lat), lon=parseFloat(city.lon);
  document.getElementById("cityName").textContent = city.display_name;
  document.getElementById("cityInfo").textContent = `Lat: ${lat}, Lon: ${lon}`;
  document.getElementById("cityImg").src = `https://source.unsplash.com/400x200/?${city.display_name}`;

  if(!userLocation){
    document.getElementById("cityStats").textContent="Concedi accesso GPS per vedere percorsi reali";
    document.getElementById("downbar").style.display="block";
    return;
  }

  const modes=["foot-walking","cycling-regular","driving-car"];
  let statsText="";
  let completed=0;

  modes.forEach(mode=>{
    fetch(`https://api.openrouteservice.org/v2/directions/${mode}?api_key=${ORS_API_KEY}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({coordinates:[[userLocation[1],userLocation[0]],[lon,lat]]})
    }).then(r=>r.json())
      .then(res=>{
        if(res.routes && res.routes.length>0){
          const duration=Math.round(res.routes[0].summary.duration/60);
          let emoji="";
          switch(mode){
            case "foot-walking": emoji="üö∂"; break;
            case "cycling-regular": emoji="üö¥"; break;
            case "driving-car": emoji="üöó"; break;
          }
          statsText += `${emoji} ${duration} min | `;
        }
      }).finally(()=>{
        completed++;
        if(completed===modes.length){
          statsText=statsText.slice(0,-3);
          document.getElementById("cityStats").textContent=statsText;
          document.getElementById("downbar").style.display="block";
        }
      });
  });
}
</script>
</body>
</html>
