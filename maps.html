<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maps Aura</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root { --magenta: #E515F6; --radius:12px; }
body, html { margin:0; padding:0; height:100%; font-family:'Poppins',sans-serif; overflow:hidden; }
#topbar { height:56px; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 16px; box-shadow:0 2px 4px rgba(0,0,0,0.1); position:fixed; top:0; left:0; right:0; z-index:1500; }
#sidebar { position:fixed; top:56px; left:12px; bottom:12px; width:300px; max-width:86%; background:#fff; border-radius:var(--radius); padding:16px; overflow-y:auto; transform:translateX(-110%); transition:transform 0.22s ease; z-index:1400; }
.sidebarOpen { transform:translateX(0); }
#map { position:absolute; top:56px; bottom:0; left:0; right:0; }
#downbar { position:fixed; bottom:12px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:#fff; border-radius:var(--radius); padding:16px; display:none; z-index:1600; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
#downbar button.close { float:right; background:none; border:none; font-size:18px; cursor:pointer; }
.topbar-img { width:40px; height:40px; border-radius:50%; cursor:pointer; object-fit:cover; }
.hamburger { font-size:24px; cursor:pointer; }
button, input { font-family:'Poppins', sans-serif; }
input { padding:8px; border:1px solid #ccc; border-radius:8px; margin-bottom:8px; width:100%; }
button { padding:8px; border:none; border-radius:8px; background:var(--magenta); color:#fff; cursor:pointer; margin-top:4px; }
ul { list-style:none; padding-left:0; }
ul li { padding:4px 0; cursor:pointer; border-bottom:1px solid #eee; }
</style>
</head>
<body>

<div id="topbar">
    <span class="hamburger">&#9776;</span>
    <img src="" id="profileImg" class="topbar-img" alt="Profilo">
</div>

<div id="sidebar">
    <h3>Preferiti</h3>
    <ul id="favoritesList"></ul>
    <hr>
    <h3>Cerca città</h3>
    <input type="text" id="searchCity" placeholder="Nome città...">
    <button id="searchBtn">Cerca</button>
</div>

<div id="downbar">
    <button class="close">&times;</button>
    <div id="downbarContent"></div>
</div>

<div id="map"></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
    authDomain: "myauraid-f03c6.firebaseapp.com",
    projectId: "myauraid-f03c6",
    storageBucket: "myauraid-f03c6.appspot.com",
    messagingSenderId: "190478237725",
    appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let user;
const profileImg = document.getElementById('profileImg');
const sidebar = document.getElementById('sidebar');
const hamburger = document.querySelector('.hamburger');
const downbar = document.getElementById('downbar');
const downbarContent = document.getElementById('downbarContent');
const favoritesList = document.getElementById('favoritesList');
const searchCity = document.getElementById('searchCity');
const searchBtn = document.getElementById('searchBtn');

auth.onAuthStateChanged(async u => {
    if(!u){ window.location.href='index.html'; return; }
    user = u;

    const userDocRef = db.collection('users').doc(user.uid);
    const mapsColRef = userDocRef.collection('Maps');

    // crea Maps se non esiste
    const snapshot = await mapsColRef.limit(1).get();
    if(snapshot.empty){
        await mapsColRef.add({ luogo:{}, favorite:false, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
    }

    // profile image
    const userDoc = await userDocRef.get();
    profileImg.src = (userDoc.exists && userDoc.data().profileImage) ? userDoc.data().profileImage
        : 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect fill="%23f6f6f9" width="100%" height="100%"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="40" fill="%23d0d0d8">A</text></svg>';

    attachFavoritesListener();
});

hamburger.addEventListener('click', ()=> sidebar.classList.toggle('sidebarOpen'));
downbar.querySelector('.close').addEventListener('click', ()=> downbar.style.display='none');

function attachFavoritesListener(){
    const favRef = db.collection('users').doc(user.uid).collection('Maps');
    favRef.onSnapshot(snap=>{
        favoritesList.innerHTML='';
        snap.forEach(doc=>{
            const data = doc.data();
            if(data.favorite && data.luogo && data.luogo.name){
                const li = document.createElement('li');
                li.textContent = data.luogo.name;
                li.onclick = ()=> showDownbar(data.luogo);
                favoritesList.appendChild(li);
            }
        });
    });
}

function showDownbar(luogo){
    downbarContent.innerHTML='';
    if(luogo.cap!==undefined){ // città
        downbarContent.innerHTML=`
            <h4>${luogo.name}</h4>
            <p>${luogo.cap}, ${luogo.region || ''}, ${luogo.country || ''}</p>
            <p>Camminando: ${luogo.walk||'-'} min, Bici: ${luogo.bike||'-'} min, Auto: ${luogo.car||'-'} min, Bus: ${luogo.bus||'-'} min</p>
            <img src="${luogo.photo||''}" style="width:100%; border-radius:var(--radius); margin-top:8px;">
        `;
    } else { // POI
        downbarContent.innerHTML=`
            <h4>${luogo.name}</h4>
            <p>Indirizzo: ${luogo.street||'-'}</p>
            <p>Categoria: ${luogo.category||'-'}</p>
            <p>Recensioni: ${luogo.reviews||'-'}</p>
        `;
    }
    downbar.style.display='block';
}

/* MAP */
let map = L.map('map').setView([41.9, 12.5], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

/* POSIZIONE UTENTE */
const locBtn = document.createElement('button');
locBtn.textContent='Mostra dove sei';
locBtn.style.position='fixed';
locBtn.style.top='60px';
locBtn.style.right='16px';
locBtn.style.zIndex='1600';
document.body.appendChild(locBtn);

locBtn.addEventListener('click', ()=>{
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            const lat=pos.coords.latitude, lon=pos.coords.longitude;
            map.setView([lat,lon],14);
            L.marker([lat,lon]).addTo(map).bindPopup("Sei qui!").openPopup();
        },()=>{alert('Impossibile ottenere la posizione');});
    } else alert('Geolocalizzazione non supportata');
});

/* CERCA CITTA */
searchBtn.addEventListener('click', async ()=>{
    const city = searchCity.value.trim();
    if(!city) return;
    sidebar.classList.remove('sidebarOpen');

    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
    const data = await res.json();
    if(data.length){
        const cityData = data[0];
        const luogo = {
            name: cityData.display_name,
            lat: cityData.lat,
            lon: cityData.lon,
            cap: cityData.postcode || '',
            region: cityData.state || '',
            country: cityData.country || '',
            walk:'-', bike:'-', car:'-', bus:'-', photo:''
        };
        showDownbar(luogo);
        map.setView([luogo.lat, luogo.lon], 12);
    }
});

/* CARICA POI AUTOMATICAMENTE */
async function loadPOI(){
    const bbox = map.getBounds();
    const query = `
    [out:json][timeout:25];
    (
      node["amenity"~"restaurant|hotel"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      way["amenity"~"restaurant|hotel"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      relation["amenity"~"restaurant|hotel"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
    );
    out center;
    `;
    const res = await fetch("https://overpass-api.de/api/interpreter", {method:"POST", body:query});
    const data = await res.json();
    data.elements.forEach(el=>{
        const lat = el.lat || el.center.lat;
        const lon = el.lon || el.center.lon;
        const name = el.tags.name || "Sconosciuto";
        const addr = el.tags["addr:street"] || "";
        const category = el.tags.amenity || "";
        const marker = L.marker([lat, lon]).addTo(map);
        marker.on('click', () => showDownbar({name, street:addr, category, reviews:"-"}));
    });
}
map.on('moveend', loadPOI);
loadPOI();
</script>
</body>
</html>
